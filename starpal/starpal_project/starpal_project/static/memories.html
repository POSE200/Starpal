<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星伴AI - 长期记忆管理</title>
    <link rel="stylesheet" href="assets/starpal-style.css">
    <style>
        .memory-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .memory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .memory-list {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        .memory-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }
        .memory-item:last-child {
            border-bottom: none;
        }
        .memory-item:hover {
            background-color: #f5f5f5;
        }
        .memory-content {
            margin-bottom: 10px;
        }
        .memory-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        .memory-actions {
            position: absolute;
            right: 10px;
            top: 10px;
            display: none;
        }
        .memory-item:hover .memory-actions {
            display: block;
        }
        .memory-importance {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
        }
        .importance-high {
            background-color: #ffebee;
            color: #c62828;
        }
        .importance-medium {
            background-color: #fff8e1;
            color: #ff8f00;
        }
        .importance-low {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .memory-empty {
            text-align: center;
            padding: 40px;
            color: #757575;
        }
        .memory-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .memory-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
        }
        .memory-stats {
            background-color: #f0f7ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        .stat-label {
            font-size: 14px;
            color: #555;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-logo">
            <h1>星伴AI <small>长期记忆管理</small></h1>
        </div>
        <div class="header-nav">
            <a href="chat.html" class="nav-link">返回聊天</a>
        </div>
    </header>

    <main class="memory-container">
        <div class="memory-stats">
            <div class="stat-item">
                <div class="stat-value" id="totalMemories">-</div>
                <div class="stat-label">总记忆数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="highImportanceCount">-</div>
                <div class="stat-label">重要记忆</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastUpdated">-</div>
                <div class="stat-label">最近更新</div>
            </div>
        </div>

        <div class="memory-header">
            <h2>长期记忆</h2>
            <div>
                <button id="refreshBtn" class="btn btn-secondary">刷新</button>
                <button id="clearAllBtn" class="btn btn-danger">清除所有记忆</button>
            </div>
        </div>

        <div class="memory-list" id="memoryList">
            <div class="memory-empty">加载中...</div>
        </div>
    </main>

    <div id="editMemoryModal" class="memory-modal">
        <div class="memory-modal-content">
            <h3>编辑记忆</h3>
            <textarea id="memoryEditor" rows="6" style="width: 100%; margin: 10px 0;"></textarea>
            <div>
                <label>重要性:</label>
                <select id="importanceSelector">
                    <option value="high">高</option>
                    <option value="medium">中</option>
                    <option value="low">低</option>
                </select>
            </div>
            <div style="margin-top: 15px; text-align: right;">
                <button id="cancelEditBtn" class="btn btn-secondary">取消</button>
                <button id="saveMemoryBtn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 登录校验
            if (!storageManager.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }

            const memoryList = document.getElementById('memoryList');
            const editMemoryModal = document.getElementById('editMemoryModal');
            const memoryEditor = document.getElementById('memoryEditor');
            const importanceSelector = document.getElementById('importanceSelector');
            const refreshBtn = document.getElementById('refreshBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const saveMemoryBtn = document.getElementById('saveMemoryBtn');
            const totalMemories = document.getElementById('totalMemories');
            const highImportanceCount = document.getElementById('highImportanceCount');
            const lastUpdated = document.getElementById('lastUpdated');

            let currentEditMemoryId = null;
            let memories = [];

            // 获取长期记忆
            async function loadMemories() {
                try {
                    memoryList.innerHTML = '<div class="memory-empty">加载中...</div>';
                    const username = storageManager.getCurrentUser();
                    const response = await apiClient.getLongTermMemories(username, 50);
                    
                    if (response.success && response.memories && response.memories.length > 0) {
                        memories = response.memories;
                        renderMemories(memories);
                        updateStats(memories);
                    } else {
                        memoryList.innerHTML = '<div class="memory-empty">暂无长期记忆</div>';
                        updateStats([]);
                    }
                } catch (error) {
                    console.error('加载记忆失败:', error);
                    memoryList.innerHTML = '<div class="memory-empty">加载记忆失败</div>';
                }
            }

            // 渲染记忆列表
            function renderMemories(memories) {
                memoryList.innerHTML = '';
                if (!memories || memories.length === 0) {
                    memoryList.innerHTML = '<div class="memory-empty">暂无长期记忆</div>';
                    return;
                }

                memories.forEach(memory => {
                    const memoryItem = document.createElement('div');
                    memoryItem.className = 'memory-item';
                    
                    // 设置重要性标签
                    const importanceClass = memory.importance === 'high' ? 'importance-high' : 
                                            memory.importance === 'medium' ? 'importance-medium' : 'importance-low';
                    const importanceText = memory.importance === 'high' ? '重要' : 
                                          memory.importance === 'medium' ? '一般' : '普通';
                    
                    // 格式化时间
                    const createdTime = memory.created_at ? new Date(memory.created_at).toLocaleString() : '未知时间';
                    
                    memoryItem.innerHTML = `
                        <div class="memory-content">${memory.memory}</div>
                        <div class="memory-meta">
                            <div>
                                <span class="memory-importance ${importanceClass}">${importanceText}</span>
                                <span>${createdTime}</span>
                            </div>
                        </div>
                        <div class="memory-actions">
                            <button class="btn btn-small btn-secondary edit-btn" data-id="${memory.id}">编辑</button>
                            <button class="btn btn-small btn-danger delete-btn" data-id="${memory.id}">删除</button>
                        </div>
                    `;
                    
                    memoryList.appendChild(memoryItem);
                });

                // 添加编辑按钮事件
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const memoryId = this.getAttribute('data-id');
                        const memory = memories.find(m => m.id === memoryId);
                        if (memory) {
                            openEditModal(memory);
                        }
                    });
                });

                // 添加删除按钮事件
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const memoryId = this.getAttribute('data-id');
                        if (confirm('确定要删除这条记忆吗？')) {
                            deleteMemory(memoryId);
                        }
                    });
                });
            }

            // 更新统计信息
            function updateStats(memories) {
                totalMemories.textContent = memories.length || 0;
                
                const highImportance = memories.filter(m => m.importance === 'high').length;
                highImportanceCount.textContent = highImportance || 0;
                
                let latestDate = memories.length > 0 ? 
                    new Date(Math.max(...memories.map(m => m.updated_at ? new Date(m.updated_at) : 0))) : 
                    null;
                lastUpdated.textContent = latestDate ? latestDate.toLocaleDateString() : '-';
            }

            // 打开编辑模态框
            function openEditModal(memory) {
                memoryEditor.value = memory.memory;
                importanceSelector.value = memory.importance || 'medium';
                currentEditMemoryId = memory.id;
                editMemoryModal.style.display = 'flex';
            }

            // 关闭编辑模态框
            function closeEditModal() {
                editMemoryModal.style.display = 'none';
                currentEditMemoryId = null;
            }

            // 保存编辑的记忆
            async function saveMemory() {
                if (!currentEditMemoryId) return;
                
                try {
                    const newText = memoryEditor.value.trim();
                    const importance = importanceSelector.value;
                    
                    if (!newText) {
                        alert('记忆内容不能为空');
                        return;
                    }
                    
                    const metadata = { importance };
                    const response = await apiClient.updateLongTermMemory(currentEditMemoryId, newText, metadata);
                    
                    if (response.success) {
                        closeEditModal();
                        loadMemories();
                    } else {
                        alert('保存失败: ' + (response.message || '未知错误'));
                    }
                } catch (error) {
                    console.error('保存记忆失败:', error);
                    alert('保存失败: ' + error.message);
                }
            }

            // 删除记忆
            async function deleteMemory(memoryId) {
                try {
                    const response = await apiClient.deleteLongTermMemory(memoryId);
                    
                    if (response.success) {
                        loadMemories();
                    } else {
                        alert('删除失败: ' + (response.message || '未知错误'));
                    }
                } catch (error) {
                    console.error('删除记忆失败:', error);
                    alert('删除失败: ' + error.message);
                }
            }

            // 清除所有记忆
            async function clearAllMemories() {
                if (!confirm('确定要清除所有长期记忆吗？此操作不可恢复！')) {
                    return;
                }
                
                try {
                    const response = await apiClient.clearLongTermMemories();
                    
                    if (response.success) {
                        loadMemories();
                    } else {
                        alert('清除失败: ' + (response.message || '未知错误'));
                    }
                } catch (error) {
                    console.error('清除记忆失败:', error);
                    alert('清除失败: ' + error.message);
                }
            }

            // 事件绑定
            refreshBtn.addEventListener('click', loadMemories);
            clearAllBtn.addEventListener('click', clearAllMemories);
            cancelEditBtn.addEventListener('click', closeEditModal);
            saveMemoryBtn.addEventListener('click', saveMemory);

            // 初始加载
            loadMemories();
        });
    </script>
</body>
</html>
